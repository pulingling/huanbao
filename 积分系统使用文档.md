# 积分系统使用文档

## 概述

本积分系统为四川生态环境宣教中心小程序提供完整的积分管理功能，包括积分获取、记录、查询和管理等功能。系统采用前后端分离架构，前端集成在微信小程序中，后端部署在云服务器上。

## 系统架构

### 前端组件
- **积分追踪器** (`utils/points.js`): 核心积分管理模块
- **分享追踪器** (`utils/shareTracker.js`): 分享功能积分追踪
- **浏览追踪器** (`utils/browseTracker.js`): 页面浏览积分追踪
- **视频追踪器** (`utils/videoTracker.js`): 视频观看积分追踪

### 后端服务
- **API服务器**: `http://115.190.2.150:8080`
- **数据库**: SQLite数据库存储积分记录
- **管理后台**: 提供积分管理和查询功能

## 积分获取规则

### 每日积分限制
- 每日最多可获得 **50积分**
- 各类活动有独立的每日限制

### 积分获取方式

#### 1. 每日登录 (5积分/次)
- 每日首次登录获得5积分
- 每日限制：1次

#### 2. 浏览内容 (2积分/次)
- 浏览环保知识：60秒获得积分
- 浏览环保读物：90秒获得积分  
- 浏览环保课件：90秒获得积分
- 浏览美境行动：60秒获得积分
- 每日限制：每类内容5次

#### 3. 观看视频 (5积分/次)
- 观看环保视频80%以上获得积分
- 每日限制：5次

#### 4. 分享内容 (2积分/次)
- 分享页面或内容获得积分
- 每日限制：5次

## API接口文档

### 基础URL
```
http://115.190.2.150:8080/api/points
```

### 接口列表

#### 1. 每日登录积分
```http
POST /daily-login
Content-Type: application/json

{
  "openid": "用户openid"
}
```

#### 2. 浏览时长积分
```http
POST /browse-duration
Content-Type: application/json

{
  "openid": "用户openid",
  "content_type": "内容类型",
  "duration_seconds": 浏览时长(秒)
}
```

#### 3. 视频观看积分
```http
POST /video-watch
Content-Type: application/json

{
  "openid": "用户openid",
  "video_id": "视频ID",
  "video_title": "视频标题",
  "watched_duration": 观看时长(秒),
  "total_duration": 视频总时长(秒)
}
```

#### 4. 分享积分
```http
POST /share
Content-Type: application/json

{
  "openid": "用户openid",
  "share_type": "分享类型",
  "content_id": "内容ID"
}
```

#### 5. 获取每日状态
```http
GET /daily-status?openid=用户openid
```

#### 6. 获取积分记录
```http
GET /records?page=1&limit=10
```

## 前端集成指南

### 1. 引入积分追踪器

```javascript
const pointsTracker = require("../../utils/points.js");
```

### 2. 页面浏览追踪

```javascript
// 在页面onShow方法中开始追踪
onShow: function() {
  pointsTracker.startPageTracking('页面类型');
}
```

### 3. 分享功能集成

```javascript
const shareTracker = require("../../utils/shareTracker.js");

onShareAppMessage: function() {
  // 记录分享积分
  pointsTracker.recordShare('分享类型', '分享标题');
  
  return shareTracker.getShareConfig(
    "分享标题",
    "pages/path/to/page"
  );
}
```

### 4. 视频观看追踪

```javascript
const videoTracker = require("../../utils/videoTracker.js");

// 开始视频追踪
videoTracker.startTracking(videoId, videoTitle, totalDuration);

// 结束视频追踪
videoTracker.endTracking();
```

## 已集成页面列表

### 完全集成的页面
- `pages/index/index.js` - 首页
- `pages/points/points.js` - 积分中心
- `pages/enviromentEdu/enviromentEdu.js` - 环境教育
- `pages/activity_detail/activity_detail.js` - 活动详情
- `pages/learn/learn.js` - 学习中心
- `pages/onlineBooks/book.js` - 在线读物
- `pages/footmark/footmark.js` - 足迹页面

### 功能特性
- ✅ 页面浏览时长追踪
- ✅ 分享功能积分记录
- ✅ 每日登录积分
- ✅ 视频观看积分
- ✅ 积分状态查询

## 配置说明

### 积分系统配置
在 `utils/points.js` 中可以配置：

```javascript
// API基础URL
const pointsApiBase = 'http://115.190.2.150:8080/api/points';

// 浏览时长阈值（秒）
const BROWSE_THRESHOLDS = {
  knowledge: 60,    // 环保知识
  reading: 90,      // 环保读物
  courseware: 90,   // 环保课件
  action: 60        // 美境行动
};
```

### 视频追踪配置
在 `utils/videoTracker.js` 中可以配置：

```javascript
// 视频观看完成度阈值
const COMPLETION_THRESHOLD = 0.8; // 80%
```

## 数据库结构

### 积分记录表 (points_records)
- `id`: 记录ID
- `user_openid`: 用户openid
- `points_change`: 积分变化
- `reason`: 获得原因
- `balance_after`: 操作后余额
- `created_at`: 创建时间
- `nickname`: 用户昵称

### 每日记录表 (daily_records)
- `id`: 记录ID
- `user_openid`: 用户openid
- `record_date`: 记录日期
- `activity_type`: 活动类型
- `count`: 次数
- `points_earned`: 获得积分

## 部署说明

### 后端部署
1. 服务器地址：`115.190.2.150`
2. 端口：`8080`
3. 启动命令：
```bash
cd /root/points_admin
uvicorn points_admin_server:app --host 0.0.0.0 --port 8080
```

### 前端部署
1. 确保所有积分追踪文件已正确放置在 `utils/` 目录
2. 在需要积分功能的页面中引入相应的追踪器
3. 在 `app.js` 中添加全局积分处理逻辑

## 常见问题

### Q: 积分没有正确记录怎么办？
A: 检查以下几点：
1. 网络连接是否正常
2. API服务器是否运行
3. 用户openid是否正确获取
4. 是否超过每日积分限制

### Q: 如何查看积分记录？
A: 可以通过以下方式：
1. 小程序积分中心页面
2. 调用 `/api/points/records` 接口
3. 直接查询数据库

### Q: 如何修改积分规则？
A: 需要同时修改：
1. 前端配置文件 (`utils/points.js`)
2. 后端业务逻辑 (`points/business.py`)
3. 数据库配置

## 技术支持

如有技术问题，请联系开发团队或查看相关代码注释。

---

**版本**: 1.0  
**更新日期**: 2025年1月  
**维护团队**: 四川生态环境宣教中心技术团队